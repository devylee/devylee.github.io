<!DOCTYPE html>
<html>
<head>
    <!-- [[! Document Settings ]] -->
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />

    <meta name="HandheldFriendly" content="True" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />

    <link rel="shortcut icon" href="/favicon.ico" >

    <!-- [[! Styles'n'Scripts ]] -->
    <link rel="stylesheet" type="text/css" href="//fonts.googleapis.com/css?family=Merriweather:300,700,700italic,300italic|Open+Sans:700,400" />
    <link rel="stylesheet" type="text/css" href="/assets/css/screen.css" />
    <link rel="stylesheet" type="text/css" href="/assets/css/syntax.css" />

    <!-- [[! Ghost outputs important style and meta data with this tag ]] -->
    


    <link rel="canonical" href="https://devylee.github.io/post/2017/04/mirror-a-remote-site-and-replace-html-content-using-nginx.html" />
    <meta name="referrer" content="origin" />

    <title>elsewhere | 用Nginx镜像远程站点并替换HTML</title>
    <meta name="description" content="Nginx可以做很多事，除了我们最常用的做Web服务器和反向代理，它其实还可以让我们做很多的“小动作”，比如本文要介绍的镜像一个站点、替换HTTP的响应内容。" />

    <meta property="og:site_name" content="elsewhere" />
    <meta property="og:type" content="article" />
    <meta property="og:url" content="https://devylee.github.io/post/2017/04/mirror-a-remote-site-and-replace-html-content-using-nginx.html" />
    <meta property="og:title" content="elsewhere | 用Nginx镜像远程站点并替换HTML" />
    <meta property="og:description" content="Nginx可以做很多事，除了我们最常用的做Web服务器和反向代理，它其实还可以让我们做很多的“小动作”，比如本文要介绍的镜像一个站点、替换HTTP的响应内容。" />

    <meta name="twitter:card" content="summary_large_image" />
    <meta name="twitter:url" content="https://devylee.github.io/post/2017/04/mirror-a-remote-site-and-replace-html-content-using-nginx.html" />
    <meta name="twitter:site" content="@idevylee" />
    <meta name="twitter:title" content="elsewhere | 用Nginx镜像远程站点并替换HTML" />
    <meta name="twitter:description" content="Nginx可以做很多事，除了我们最常用的做Web服务器和反向代理，它其实还可以让我们做很多的“小动作”，比如本文要介绍的镜像一个站点、替换HTTP的响应内容。" />

    <script type="application/ld+json">
{
    "@context": "http://schema.org",
    "@type": "Article",
    "author": "Devy",
    "publisher": "elsewhere",
    "url": "https://devylee.github.io/post/2017/04/mirror-a-remote-site-and-replace-html-content-using-nginx.html",
    "description": "Nginx可以做很多事，除了我们最常用的做Web服务器和反向代理，它其实还可以让我们做很多的“小动作”，比如本文要介绍的镜像一个站点、替换HTTP的响应内容。"
}
    </script>

    <meta name="generator" content="Jekyll" />
    <link rel="alternate" type="application/rss+xml" title="elsewhere" href="/feed.xml" />


</head>

<body class="post-template nav-closed">

    <div class="nav">
    <h3 class="nav-title">Menu</h3>
    <a href="#" class="nav-close">
        <span class="hidden">Close</span>
    </a>
    <ul>
        <li class="nav-home "><a href="/">Home</a></li>
        <li class="nav-about "><a href="/about/">About</a></li>
        <li class="nav-github-repos"><a href="https://github.com/devylee/">Github repos</a></li>
    </ul>
    <a class="subscribe-button icon-feed" href="/feed.xml">Subscribe</a>
</div>
<span class="nav-cover"></span>


    <div class="site-wrapper">

        <!-- [[! Everything else gets inserted here ]] -->
        <!-- < default -->

<!-- The comment above "< default" means - insert everything in this file into -->
    <!-- the [body] of the default.hbs template, which contains our header/footer. -->

<!-- Everything inside the #post tags pulls data from the post -->
<!-- #post -->
<header class="main-header post-head no-cover">
    <nav class="main-nav  clearfix">
        
        
            <a class="menu-button icon-menu" href="#"><span class="word">Menu</span></a>
        
    </nav>
</header>

<main class="content" role="main">

    <article class="post tag-nginx tag-docker tag-sae">

        <header class="post-header">
            <h1 class="post-title">用Nginx镜像远程站点并替换HTML</h1>
            <section class="post-meta">
            <time class="post-date" datetime="2017-04-21">21 Apr 2017</time>
                <!-- [[tags prefix=" on "]] -->
                 
                on 
                
                    
                    
                       <a href='/tag/nginx/'>Nginx</a>,
                       
                
                    
                    
                       <a href='/tag/docker/'>Docker</a>,
                       
                
                    
                    
                       <a href='/tag/sae/'>SAE</a>
                       
                
                
            </section>
        </header>

        <section class="post-content">
            
            <blockquote>
  <p>Nginx可以做很多事，除了我们最常用的做Web服务器和反向代理，它其实还可以让我们做很多的“小动作”，比如本文要介绍的镜像一个站点、替换HTTP的响应内容。</p>
</blockquote>

<!--more-->

<p><strong>来，容我先描述一下需求：</strong> <a href="https://devylee.github.io">https://devylee.github.io</a>，这是我的Github Page；<a href="http://devylee.me">devylee.me</a>这是我的一个域名，而且经过一系列的波折，在<a href="http://sinacloud.com/">新浪云</a>终于通过了工信部的备案，可以在国内用了。so，那就不要让这个域名闲着了，但我又并不想直接把这域名绑定在我的Github Page上（GH上只能绑定一个独立域名，而且不支持HTTPS），所以，我就用SAE部署一个Docker容器并绑定<a href="http://devylee.me">devylee.me</a>这个域名，然后用Nginx把请求都proxy到<a href="https://devylee.github.io">https://devylee.github.io</a>，顺便在返回的HTML页面中注入备案号。</p>

<p>需求很简单吧，来，让我们撸起袖子干吧！</p>

<p>首先上Dockerfile（SAE上如何部署Dockerfile可以参考我之前的文章“<a href="/post/2017/04/docker-a-ghost-blog-by-sae.html">用SAE Docker一个Ghost博客</a>”）：</p>

<blockquote>
  <p>我这里监听的端口是5050，这个要看你的SAE应用中环境变量<code class="highlighter-rouge">PORT</code>的具体值。</p>
</blockquote>

<pre class="highlight"><code class="language-docker">FROM nginx:alpine

COPY nginx-default.conf /etc/nginx/conf.d/default.conf

EXPOSE 5050

</code></pre>

<p>nginx-default.conf：</p>

<div class="language-nginx highlighter-rouge"><pre class="highlight"><code><span class="k">server</span> <span class="p">{</span>
    <span class="kn">listen</span> <span class="mi">5050</span><span class="p">;</span>

    <span class="kn">location</span> <span class="n">/</span> <span class="p">{</span>
        <span class="kn">proxy_pass</span> <span class="s">https://devylee.github.io</span><span class="p">;</span>
        <span class="kn">proxy_redirect</span> <span class="no">off</span><span class="p">;</span>

        <span class="kn">sub_filter</span> <span class="s">'All</span> <span class="s">Rights</span> <span class="s">Reserved.'</span> <span class="s">'All</span> <span class="s">Rights</span> <span class="s">Reserved.</span> <span class="s">&lt;a</span> <span class="s">href="http://www.miitbeian.gov.cn"&gt;辽ICP备16011865号&lt;/a&gt;'</span><span class="p">;</span>
    <span class="p">}</span>

<span class="p">}</span>
</code></pre>
</div>

<p>如此，push并确认成功后，在浏览器输入devylee.me，哦，没错，这就是我的Github Page！不过，备案号呢？貌似sub_filter并未起作用啊！</p>

<p>经过各种尝试（甚至是更换镜像源，从头编译nginx，然并卵！），最终找到原因原来是因为<code class="highlighter-rouge">Accept-Encoding</code>！</p>

<p>怎么回事？因为现在几乎所有的Web服务器都支持gzip压缩的，也就是<code class="highlighter-rouge">Accept-Encoding: gzip</code>，而且默认情况下就是启用的，当然Github Page也不例外！于是乎，我们的Nginx
通过proxy_pass得到的响应内容其实是被gzip过的，所以，sub_filter就根本不起作用！找到问题所在，接下来就简单了，我们只要对nginx-default.conf稍加改造（增加一行<code class="highlighter-rouge">proxy_set_header Accept-Encoding ""</code>）就可以了：</p>

<div class="language-nginx highlighter-rouge"><pre class="highlight"><code><span class="k">server</span> <span class="p">{</span>
    <span class="kn">listen</span> <span class="mi">5050</span><span class="p">;</span>

    <span class="kn">location</span> <span class="n">/</span> <span class="p">{</span>
        <span class="kn">proxy_pass</span> <span class="s">https://devylee.github.io</span><span class="p">;</span>
        <span class="kn">proxy_redirect</span> <span class="no">off</span><span class="p">;</span>
        <span class="kn">proxy_set_header</span> <span class="s">Accept-Encoding</span> <span class="s">""</span><span class="p">;</span>

        <span class="kn">sub_filter</span> <span class="s">'All</span> <span class="s">Rights</span> <span class="s">Reserved.'</span> <span class="s">'All</span> <span class="s">Rights</span> <span class="s">Reserved.</span> <span class="s">&lt;a</span> <span class="s">href="http://www.miitbeian.gov.cn"&gt;辽ICP备16011865号&lt;/a&gt;'</span><span class="p">;</span>
    <span class="p">}</span>

<span class="p">}</span>
</code></pre>
</div>

<p>OK！再次push，刷新浏览器~</p>

<p>嗯！有没有觉得so easy啊！</p>

<hr />

<p><em>参考：</em></p>

<ol>
  <li><a href="http://nginx.org/en/docs/http/ngx_http_sub_module.html">Nginx <code class="highlighter-rouge">ngx_http_sub_module</code> Module</a></li>
</ol>


        </section>

        <footer class="post-footer">

            <!-- Everything inside the #author tags pulls data from the author -->
            <!-- #author-->
            
            
            <figure class="author-image">
                <a class="img" href="/author/devy/" style="background-image: url(https://github.com/devylee.png?size=136)"><span class="hidden">Devy's Picture</span></a>
            </figure>
            

            <section class="author">
                <h4><a href="/author/devy/">Devy</a></h4>
                
                
                    <p> 代码猴' 全栈' 真爱LNMP' 勾搭着一众开发技术' 拖延症患者' 已婚俩孩儿带只狗'</p>
                
                <div class="author-meta">
                    <span class="author-location icon-location"> Dalian, China</span> 
                </div>
            </section>

            <!-- /author  -->

            <section class="share">
                <h4>Share this post</h4>
                <a class="icon-twitter" href="http://twitter.com/share?text=%E7%94%A8Nginx%E9%95%9C%E5%83%8F%E8%BF%9C%E7%A8%8B%E7%AB%99%E7%82%B9%E5%B9%B6%E6%9B%BF%E6%8D%A2HTML&url=https://devylee.github.io/post/2017/04/mirror-a-remote-site-and-replace-html-content-using-nginx.html"
                    onclick="window.open('http://twitter.com/share?text=%E7%94%A8Nginx%E9%95%9C%E5%83%8F%E8%BF%9C%E7%A8%8B%E7%AB%99%E7%82%B9%E5%B9%B6%E6%9B%BF%E6%8D%A2HTML&url=' + encodeURIComponent(window.location.href), 'twitter-share', 'width=550,height=235');return false;">
                    <span class="hidden">Twitter</span>
                </a>
                <a class="icon-facebook" href="https://www.facebook.com/sharer/sharer.php?u=https://devylee.github.io/post/2017/04/mirror-a-remote-site-and-replace-html-content-using-nginx.html"
                    onclick="window.open('https://www.facebook.com/sharer/sharer.php?u=' + encodeURIComponent(window.location.href), 'facebook-share','width=580,height=296');return false;">
                    <span class="hidden">Facebook</span>
                </a>
                <a class="icon-weibo" href="http://service.weibo.com/share/share.php?url=https://devylee.github.io/post/2017/04/mirror-a-remote-site-and-replace-html-content-using-nginx.html&title=%E7%94%A8Nginx%E9%95%9C%E5%83%8F%E8%BF%9C%E7%A8%8B%E7%AB%99%E7%82%B9%E5%B9%B6%E6%9B%BF%E6%8D%A2HTML"
                   onclick="window.open('http://service.weibo.com/share/share.php?title=%E7%94%A8Nginx%E9%95%9C%E5%83%8F%E8%BF%9C%E7%A8%8B%E7%AB%99%E7%82%B9%E5%B9%B6%E6%9B%BF%E6%8D%A2HTML&url=' + encodeURIComponent(window.location.href), 'weibo-share', 'width=560,height=530');return false;">
                    <span class="hidden">Weibo</span>
                </a>
            </section>
            
            
                <!-- Add Disqus Comments -->
                <div id="disqus_thread"></div>
<script>
    /**
    *  RECOMMENDED CONFIGURATION VARIABLES: EDIT AND UNCOMMENT THE SECTION BELOW TO INSERT DYNAMIC VALUES FROM YOUR PLATFORM OR CMS.
    *  LEARN WHY DEFINING THESE VARIABLES IS IMPORTANT: https://disqus.com/admin/universalcode/#configuration-variables
    */
    var disqus_config = function () {
        this.page.url = 'https://devylee.github.io/post/2017/04/mirror-a-remote-site-and-replace-html-content-using-nginx.html';  // Replace PAGE_URL with your page's canonical URL variable
        this.page.identifier = '/post/2017/04/mirror-a-remote-site-and-replace-html-content-using-nginx.html'; // Replace PAGE_IDENTIFIER with your page's unique identifier variable
    };
    (function(){
        document.addEventListener('DOMContentLoaded', function() {
            ping('https://devylee.disqus.com/count.js').then(function(delta) {
                var d = document, s = d.createElement('script');
                s.src = '//devylee.disqus.com/embed.js';  // IMPORTANT: Replace EXAMPLE with your forum shortname!
                s.setAttribute('data-timestamp', +new Date());
                (d.head || d.body).appendChild(s);
            });
        });
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript" rel="nofollow">comments powered by Disqus.</a></noscript>
            
            
        </footer>

    </article>

</main>

<aside class="read-next">

    <!-- [[! next_post ]] -->
    
        <a class="read-next-story no-cover" href="/post/2017/06/a-sample-front-end-solution-using-webpack.html">
            <section class="post">
                <h2>在Web前端开发中使用Node和webpack</h2>
                <p>
  标题说的很明白，本文我只介绍使用Node和webpack来实现的一个Web前端的构建方案，而不是一个Node实现的全栈方案。至于后端，其实我个人觉得有很多比Node更好的选择，但这不是本文的重点。


</p>
            </section>
        </a>
    
    <!-- [[! /next_post ]] -->
    <!-- [[! prev_post ]] -->
    
        <a class="read-next-story prev no-cover" href="/post/2017/04/using-docker-on-macos.html">
            <section class="post">
                <h2>Mac下Docker的使用</h2>
                <p>
  自从接触了Docker，我就深深的觉得：Docker的使用应该是一个开发人员，尤其是基于Linux的Web服务端开发人员应该具备的基本技能之一！其实Docker的使用也并不复杂，熟悉两个命令docker、docker-machine和一个Dockerfile就可以在你的本机开发环境中跑起来了。


</p>
            </section>
        </a>
    
    <!-- [[! /prev_post ]] -->
</aside>

<!-- /post -->


        <footer class="site-footer clearfix">
          <section class="copyright"><nobr><a href="/">elsewhere</a> &copy; 2017</nobr> <nobr>All Rights Reserved.</nobr></section>
          <section class="poweredby"><nobr>Proudly published with <a href="https://jekyllrb.com/">Jekyll</a>,</nobr> <nobr>hosted by <a href="https://github.com/devylee/devylee.github.io">Github</a>,</nobr> <nobr>theme by <a href="https://github.com/tryghost/casper">Casper</a></nobr></section>
        </footer>
    </div>
    <!-- [[! Ghost outputs important scripts and data with this tag ]] -->
    <script type="text/javascript" src="https://code.jquery.com/jquery-1.11.3.min.js"></script>
    <!-- [[! The main JavaScript file for Casper ]] -->
    <script type="text/javascript" src="/assets/js/jquery.fitvids.js"></script>
    <script type="text/javascript" src="/assets/js/index.js"></script>
    <script type="text/javascript" src="/assets/js/ping.js"></script>

    <!-- Add Google Analytics  -->
        <!-- Google Analytics Tracking code -->
     <script>
	    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
	    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
	    m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
	    })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

	    ga('create', 'UA-92777218-1', 'auto');
	    ga('send', 'pageview');

     </script>   

</body>
</html>

